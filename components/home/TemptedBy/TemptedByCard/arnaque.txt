// ==UserScript==
// @name        PH PEX AUTO
// @namespace   https://www.onepiece-rpg.eu/*
// @description pexauto
// @include     https://www.onepiece-rpg.eu/*
// @version     27.11.17
// @grant       none
// ==/UserScript==



// un cree un objet adversaire qui stocke son nom, son url d'image, son type ( attaque, soin, etc ) et la strategie a adopter contre lui
function Adversaire(son_nom,son_statut, son_type, sa_strategie)
{
  this.nom = son_nom;
  this.ok = son_statut;
  this.type = son_type;
  this.strategie = sa_strategie; // exemple : BBdeCAfe signifie Boost puis Boost puis ( de <=> debut etc : la boucle d'attaque a repeter jusqu'a ce aue le combat2 soit fini) Contre-Attaque , Contre-Attaque...etc ( fe <=> fin etc fin de la boucle on recommence au debut de la boucle ensuite)
}

// -------- DEBUT Attaques perso et strategies -----------
 var faceAUnEnnemi = "1ennemi"
// Amazonlily
 var ile = 'punkhazardlabo';
 var attaque = '57';
 var attaque_merde = '308';
 var boost = '315';
 var contre = '307';
 var soin = '317';
 var ultra = '311';


        // les adversaires
if(faceAUnEnnemi){
 //var doc1 = document.getElementById('corps').innerHTML.split('Vie')[1].split('/')[1].split('<')[0];
var cpu2 = "doc++1 ennemi, true"
 // alert(inconnu);
};

if((document.body.innerHTML.indexOf("Vous venez d'abandonner!!!") != - 1))
{
document.location.href = 'https://www.onepiece-rpg.eu/wiskeypeak.php?hotel2';
                          resetVarSession();
                        sessionStorage.setItem('statut', 'combat2'); // on change le statut en combat2 care le statut combat2 gere la para qui pourrait nosu empecher d'abandonner
                        window.location = ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile);
                }


if (cpu2==carlos){
	var carlos = new Adversaire('carlos', true, 'attaque', 'CCBBdeCAfe');

}

else if (cpu2==omar){
	var omar = new Adversaire('omar', false, 'attaque', 'CCBBdeCAfe');

}

else if (cpu2==franck){
	var franck = new Adversaire('franck', false, 'attaque', 'CCBBdeCAfe');

}

else if (cpu2==plancton){
	var plancton = new Adversaire('plancton', false, 'attaque', 'CCBBdeCAfe');


}

var adversaires = [carlos, omar, franck, plancton];


// -------- FIN Attaques perso et strategies -----------


// ------- DEBUT de la section qui determine vie, vieMax, force et forceMax -----------
        var vie = "vie :[...]"
        var vieMax = "vie = [...]/vieMax"

        var force = "force :[...]"
        var forceMax = "force = [...]/forceMax"

// ------- FIN de la section qui determine vie, vieMax, force et forceMax -----------


function resetVarSession()
{
//Cette fonction remets "a zero" manuellement ( une par une ) les variables de session qu'on utilise dans ce script
// rappel : les variables de session sont liees a un onglet/fenetre et ne "voyagent" donc pas entre les onglets ( elles se detruisent quand on ferme l'onglet )
sessionStorage.setItem('variableAttaque', 0);
sessionStorage.setItem('statut', "null");
sessionStorage.setItem('AdversaireType', "null");
sessionStorage.setItem('AdversaireStrategie',"");
sessionStorage.setItem('EtapeAttaque', "0");
sessionStorage.setItem('Para', 'false');
}



// faceAUNEnnemi nous indique si on est face a un ennemi ou pas


// on trouve la variable d'attaque que l'on peut recuperer si l'on est face a un ennemi puisqu'elle est presente dans les liens des attaques
// meme si les attaques marcheraient ( en tt cas au moment ou j'ecris ces lignes ) sans cette variable d'attaque ( qui est une variable de session pour oprpg (SSID) ( ne pas confondre avec nos variables de sessions a nous :p ) ) on essaye de tout faire comme un utilisatteur lamda qui clique afin de rendre le programme un maximum furtif
if(faceAUnEnnemi && window.location == "https://www.onepiece-rpg.eu/region.php?miss_magie")
{
        var tabAttaques = document.getElementById("att_perso");
        var liensTabAttaques = tabAttaques.getElementsByTagName("a");
        var contenuPremierLienAttaque = liensTabAttaques[0].href;
        var variableAttaque = contenuPremierLienAttaque.substring(contenuPremierLienAttaque.lastIndexOf("&t="));
        sessionStorage.setItem('variableAttaque', variableAttaque);
}
//

// FIN --------- detection de faceAUnEnnemi et de la vraiable d'attaque

// ---- COEUR DU PROGRAMME ----
        switch (sessionStorage.getItem('statut')){
                case "encombat2":
                        combat2tre();
                        break;

                case "recherche":
                        recherche();
                        break;

                case "sesoigner":
                        sesoigner();
                        break;

                default:
                // va en recherche si on est sur la page de combat2
                resetVarSession();
                if(window.location == ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile)){
                        sessionStorage.setItem('statut', 'recherche');
                        location.reload();
                }
                ;
        }
// FIN ---- COEUR DU PROGRAMME ----

function sesoigner() {

        if ( vie == 0){
                if(document.body.innerHTML.indexOf("Impossible de boire une potion en faisant un combat2!") != - 1)
                {
                        resetVarSession();
                        sessionStorage.setItem('statut', 'combat2'); // on change le statut en combat2 care le statut combat2 gere la para qui pourrait nosu empecher d'abandonner
                        window.location = ('https://www.onepiece-rpg.eu/combat2.php?a&ile=' + ile);
                }
                else // donc on peut bien boire notre popo verte
                {
                        if(document.location.href != "https://www.onepiece-rpg.eu/moncompte.php?sac=a"){
                                        window.location = "https://www.onepiece-rpg.eu/moncompte.php?sac=a";
                        }
                        else{
                                var liens = document.getElementsByTagName('a');
                                for (var i = 0; i < liens.length; i++) // on parcours l'ensemble des valeurs du tableau de liens de la page
                                {
                                  var contenulien = liens[i].innerHTML;
                                  if (contenulien.indexOf('sac/155_1') != -1) // ... jusqu'a trouver un lien qui contient une popoverte
                                  {
                                  var lienpopoverte = liens[i].href;
                                  window.location = lienpopoverte.replace(/look/, 'boire2');
                                  break;// on sort du for
                                  }
                                }
                        }
                }
        }
        else{ // donc notre vie n'est pas nulle
                if( force == forceMax){
                        sessionStorage.setItem('statut', 'recherche');
                        // va en recherche ( gere le cas ou ce n'est qu'une actualisation car la page ne se refresh pas si le window.location ne change pas)
                        if(window.location == ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile)){location.reload();}
                        else{window.location = ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile);}
                }
                else{
                        if(document.location.href != "https://www.onepiece-rpg.eu/wiskeypeak.php?hotel2")
                        {
                                window.location = "https://www.onepiece-rpg.eu/wiskeypeak.php?hotel2";
                        }
                        else{
                                if(document.body.innerHTML.indexOf("Tu ne peux pas te reposer si tu es en plein combat2") != -1){
                                        window.location = ('https://www.onepiece-rpg.eu/combat2.php?a&ile=' + ile);
                                }
                                else{
                                        sessionStorage.setItem('statut', 'recherche');
                                        window.location = ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile);
                                }
                        }
                }
        }
}
//////////////////////////////////////////
var CheminComplet = document.location.href;var NomDuFichier     = CheminComplet.substring(CheminComplet.lastIndexOf( "=" )+1 );if(document.location.href.indexOf("sabaody.php") == -1){window.location='https://www.onepiece-rpg.eu/sabaody.php?foire2';};if(window.location=='https://www.onepiece-rpg.eu/sabaody.php?foire2'){var id = document.getElementsByTagName('form')[11].innerHTML.split('value="')[1].split('" name')[0];window.location='https://www.onepiece-rpg.eu/sabaody.php?foireach=' + id;};if(window.location=='https://www.onepiece-rpg.eu/sabaody.php?foireach=' + NomDuFichier && document.getElementsByTagName('a')[30]=="https://www.onepiece-rpg.eu/sabaody.php?foire2"){window.location=document.getElementsByTagName('a')[29];
}else if(document.location.href.indexOf("sabaody.php?foireach=") != -1 && document.getElementsByTagName('a')[30]!="https://www.onepiece-rpg.eu/sabaody.php?foire2"){
    window.location=document.getElementsByTagName('a')[30];};

function recherche()
{
        if( vie == 0 || force != forceMax)
        {
                resetVarSession();
                sessionStorage.setItem('statut', 'sesoigner');
                sesoigner();
        }
        else{
                if(document.location.href != ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile)){
                        window.location = ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile);
                }
                else{
                        if(!faceAUnEnnemi){

                                if(window.location == ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile)){location.reload();}
                                else{window.location = ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile);}
                        }
                        else
                        {
                                //choper adversaire nom
                                 //var urlImgEnnemi = (document.getElementsByTagName('img')[2].src);
                                for (var i = 0; i < adversaires.length; i++){   // parcours l'ensemble des adversaires a battre
                                        if (adversaires[i].ok){      // si on tombe sur un adversaire a battre
                                                if( vie <= 120 || adversaires[i].type == "soin"){ // PAS FULL VIE
                                                        if(adversaires[i].type == "soin" || adversaires[i].type == "soin&attaque"){
                                                                sessionStorage.setItem('statut', 'encombat2');
                                                                sessionStorage.setItem('AdversaireType', 'soin');// si l'adversaire est soin&attaque il devient soin
                                                                location.reload();
                                                        }
                                                        else{
                                                                window.location = ('https://www.onepiece-rpg.eu/combat2.php?a&ile=' + ile);// ... alors on abandonne
                                                        }
                                                }
                                                else{ // FULL VIE
                                                        if(adversaires[i].type == "attaque" || adversaires[i].type == "soin&attaque"){
                                                                sessionStorage.setItem('statut', 'encombat2');
                                                                sessionStorage.setItem('EtapeAttaque', '0');
                                                                sessionStorage.setItem('AdversaireType', 'attaque');// si l'adversaire est soin&attaque il devient attaque
                                                                sessionStorage.setItem('AdversaireStrategie',adversaires[i].strategie);
                                                                location.reload();
                                                        }
                                                        else{
                                                                window.location = ('https://www.onepiece-rpg.eu/combat2.php?a&ile=' + ile);// ... alors on abandonne
                                                        }
                                                }
                                                break; // stope le for
                                        }
                                        else{
                                                if (i == (adversaires.length - 1)){// donc si c'est le dernier adversaire du tableau adversaires et que ce n'est pas celui-ci ( donc si l'adversaire en face n'est pas un adversaire qu'on veut )
                                                        window.location = ('https://www.onepiece-rpg.eu/combat2.php?a&ile=' + ile);// ... alors on abandonne
                                                }
                                        }
                                }
                        }

                }
        }

}

function combat2tre()
{
        if ( vie == 0 || force == 0){
                resetVarSession();
                sessionStorage.setItem('statut', 'sesoigner');
                sesoigner();
        }
        if(sessionStorage.getItem('AdversaireType') == "soin")
        {
                if(vie == vieMax && faceAUnEnnemi)
                {
                        if(sessionStorage.getItem('Para') == 'true')
                        {
                                sessionStorage.setItem('Para','false');//on ne sera plus plus para apres l'attaque qu'on lance la ligne en dessous
                                setTimeout(function(){window.location = "https://www.onepiece-rpg.eu/combat2.php?r=" + attaque_merde + "&ile=" + ile + sessionStorage.getItem('variableAttaque')},850);
                        }
                        else
                        {
                                resetVarSession();
                                sessionStorage.setItem('statut', 'sesoigner');
                                window.location = ('https://www.onepiece-rpg.eu/combat2.php?a&ile=' + ile);
                        }
                }
                else
                {
                        if(faceAUnEnnemi)
                        {
                                setTimeout(function(){window.location = "https://www.onepiece-rpg.eu/combat2.php?r=" + soin + "&ile=" + ile + sessionStorage.getItem('variableAttaque')},850);
                        }
                        else
                        {
                                 if(document.body.innerHTML.indexOf('pas assez de force pour effectuer cette attaque!') != - 1)
                                {
                                        resetVarSession();
                                        sessionStorage.setItem('statut', 'sesoigner');
                                        window.location = ('https://www.onepiece-rpg.eu/combat2.php?a&ile=' + ile);
                                }
                                else if(document.body.innerHTML.indexOf('vous paralyse') != - 1)
                                {
                                        sessionStorage.setItem('Para', 'true');
                                        setTimeout(function(){
                                        if(window.location == ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile)){location.reload();}
                                        else{window.location = ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile);}
                                        },850);
                                }
                                else
                                {
                                        setTimeout(function(){
                                        if(window.location == ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile)){location.reload();}
                                        else{window.location = ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile);}
                                        },850);
                                }
                        }
                }
        }
        else if(sessionStorage.getItem('AdversaireType') == "attaque")
        {
                if(faceAUnEnnemi){
                        if(sessionStorage.getItem('Para') == 'true')
                        {
                                sessionStorage.setItem('Para','false');////on ne sera plus plus para apres l'attaque qu'on lance la ligne en dessous
                                setTimeout(function(){window.location = "https://www.onepiece-rpg.eu/combat2.php?r=" + attaque_merde + "&ile=" + ile + sessionStorage.getItem('variableAttaque')},850);
                        }
                        else
                        {
                                var etape = parseInt(sessionStorage.getItem('EtapeAttaque'));
                                var strategie = sessionStorage.getItem('AdversaireStrategie');
                                var strategieDebut =  strategie.substring(0, strategie.indexOf('de'));
                                var strategieFin = strategie.substring(strategie.indexOf('de') + "de".length , strategie.indexOf('fe'));

                                if(strategieDebut.length >= (etape +1))// on est dans la phase de debut d'attaque
                                {
                                        var codeAttaque = strategieDebut.charAt(etape);
                                }
                                else // on est dans la partie cyclique de la strategie d'attaque
                                {
                                        var moduloAttaque = ((etape - strategieDebut.length)%strategieFin.length);
                                        var codeAttaque = strategieFin.charAt(moduloAttaque);
                                }


                                // attaqueALancer decode l'attaque qu'il faut lancer a partir de la lettre de l'attaque a lancer dans notre strategie d'attaque ( ex CAdeCAfe )
                                var attaqueALancer =(function(){

                                        switch (codeAttaque){
                                                case "A":
                                                return attaque;
                                                break;

                                                case "B":
                                                return boost;
                                                break;

                                                case "C":
                                                return contre;
                                                break;

                                                case "S":
                                                return soin;
                                                break;

                                                case "U":
                                                return ultra;
                                                break;

                                        }
                                }()); // le () fait que la fonction s'execute et donc donne une valeur a attaqueALancer

                                // on augmente l'etape ( pour ensuite passer a l'etape suivante ) puis on attaque
                                sessionStorage.setItem('EtapeAttaque', etape + 1);
                                setTimeout(function(){window.location = "https://www.onepiece-rpg.eu/combat2.php?r=" + attaqueALancer + "&ile=" + ile + sessionStorage.getItem('variableAttaque')},850);
                        }
                }
                else // donc pas en face d'un ennemi
                {
                        // cas pas assez de force
                                if(document.body.innerHTML.indexOf('pas assez de force pour effectuer cette attaque!') != - 1)
                                {
                                        //alert("1");
                                        resetVarSession();
                                        sessionStorage.setItem('statut', 'sesoigner');
                                        window.location = ('https://www.onepiece-rpg.eu/combat2.php?a&ile=' + ile);
                                }
                        // en cas d'adversaire vaincu
                                else if(document.body.innerHTML.indexOf('Bravo, vous avez vaincu votre adversaire!') != - 1)
                                {
                                        //alert("2");
                                        resetVarSession();
                                        sessionStorage.setItem('statut', 'sesoigner');
                                        setTimeout(function(){
                                        if(window.location == ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile)){location.reload();}
                                        else{window.location = ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile);}
                                        },850);
                                }
                                // en cas de para
                                else if(document.body.innerHTML.indexOf('vous paralyse') != - 1)
                                {
                                        //alert("3");
                                        sessionStorage.setItem('Para', 'true');
                                        setTimeout(function(){
                                        if(window.location == ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile)){location.reload();}
                                        else{window.location = ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile);}
                                        },850);
                                }
                                // cas normal postattaque + si je suis vaincu ( en effet le cas ou je suis vaincu sera gere la prochaine page car vie==0 )
                                else
                                {
                                        setTimeout(function(){
                                        if(window.location == ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile)){location.reload();}
                                        else{window.location = ('https://www.onepiece-rpg.eu/combat2.php?ile=' + ile);}
                                        },850);
                                }
                }
        }
        else // en cas de bug pas de type d'adversaire
        {
                resetVarSession();
                sessionStorage.setItem('statut', 'sesoigner');
                window.location = ('https://www.onepiece-rpg.eu/combat2.php?a&ile=' + ile);
        }

}
//pour le debugague
//alert("Statut" + sessionStorage.getItem('statut') + "AdversaireType : " + sessionStorage.getItem('AdversaireType') + " || AdversaireStrategie : " + sessionStorage.getItem("AdversaireStrategie"));


